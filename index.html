<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Citadel Nexus: Discord Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { 
            --bg-dark: #121212; --bg-side: #1e1e1e; --bg-chat: #2b2b2b;
            --gold: #d4af37; --hp: #ff4747; --xp: #47a0ff; --border: #3f3f3f;
        }
        
        body { 
            background: var(--bg-dark); color: #dcddde; font-family: 'Press Start 2P', cursive; 
            margin: 0; padding: 0; font-size: 9px; display: flex; height: 100vh; overflow: hidden;
        }

        /* --- LAYOUT TIPO DISCORD --- */
        .sidebar { 
            width: 240px; background: var(--bg-side); display: flex; flex-direction: column;
            border-right: 2px solid var(--border); transition: 0.3s;
        }
        
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); }

        @media (max-width: 768px) {
            .sidebar { width: 0; overflow: hidden; position: absolute; z-index: 100; height: 100%; }
            .sidebar.open { width: 200px; }
        }

        /* --- COMPONENTES SIDEBAR --- */
        .profile-section { padding: 20px; border-bottom: 2px solid var(--border); text-align: center; }
        .mini-avatar { width: 60px; height: 60px; border: 2px solid var(--gold); border-radius: 50%; margin: 0 auto 10px; overflow: hidden; background: #000; cursor: pointer; }
        .mini-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .channels { flex: 1; padding: 10px; overflow-y: auto; }
        .channel-item { padding: 12px; margin: 4px 0; border-radius: 4px; cursor: pointer; transition: 0.2s; color: #8e9297; }
        .channel-item:hover, .channel-item.active { background: #393c43; color: #fff; }
        .channel-item span { margin-right: 8px; color: var(--gold); }

        /* --- AREA DE CHAT --- */
        .chat-header { height: 50px; border-bottom: 2px solid var(--border); display: flex; align-items: center; padding: 0 15px; background: var(--bg-side); }
        #chatBox { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .message { border-left: 3px solid var(--gold); padding-left: 10px; animation: fadeIn 0.3s; }
        .message b { color: var(--gold); font-size: 7px; display: block; margin-bottom: 5px; }
        .message p { margin: 0; line-height: 1.6; }

        .input-area { padding: 20px; background: var(--bg-chat); }
        .input-wrapper { background: #40444b; border-radius: 8px; display: flex; padding: 5px 15px; align-items: center; }
        
        input, button { font-family: 'Press Start 2P'; background: transparent; border: none; color: #fff; padding: 10px; outline: none; }
        input { flex: 1; font-size: 8px; }
        .btn-send { color: var(--gold); cursor: pointer; }

        /* --- MISIONES & STATS --- */
        .stats-view, .mission-view { display: none; padding: 20px; }
        .stats-view.active, .mission-view.active { display: block; }
        
        .bar { background: #000; height: 12px; border: 1px solid #555; margin: 10px 0; border-radius: 5px; overflow: hidden; }
        .bar-fill { height: 100%; width: 100%; transition: 0.5s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="profile-section">
            <div class="mini-avatar" onclick="document.getElementById('fileIn').click()">
                <img id="profileImg" src="">
            </div>
            <input type="file" id="fileIn" style="display:none" accept="image/*">
            <input type="text" id="userName" style="width:100%; text-align:center; font-size:7px; background:none; border:none; color:var(--gold);" onchange="save()">
            <div class="bar"><div id="hpBar" class="bar-fill" style="background:var(--hp);"></div></div>
            <div style="font-size:6px; margin-top:5px;">ðŸ’° <span id="goldSpan">0</span>g</div>
        </div>

        <div class="channels">
            <div class="channel-item active" onclick="switchView('chat')"><span>#</span> grial-chat</div>
            <div class="channel-item" onclick="switchView('missions')"><span>#</span> gestas-24h</div>
            <div class="channel-item" onclick="switchView('stats')"><span>#</span> inventario</div>
            
            <div style="margin-top:20px; padding:10px; font-size:6px; color:#555;">SALA ID:</div>
            <div id="myId" style="font-size:5px; padding:10px; background:#000; word-break:break-all; cursor:pointer;" onclick="copyId()">Generando...</div>
            <input type="text" id="joinId" placeholder="Unirse a sala..." style="background:#000; margin-top:10px; border-radius:4px; font-size:6px;">
            <button onclick="joinRoom()" style="font-size:6px; color:var(--gold); width:100%; text-align:left; padding:10px 0;">+ UNIRSE</button>
        </div>
    </div>

    <div class="main-content">
        <div class="chat-header">
            <button onclick="toggleSidebar()" style="background:none; border:none; color:var(--gold); margin-right:15px; cursor:pointer;">â˜°</button>
            <span id="viewTitle"># grial-chat</span>
        </div>

        <div id="chatView" class="view-content active" style="flex:1; display:flex; flex-direction:column;">
            <div id="chatBox"></div>
            <div class="input-area">
                <div class="input-wrapper">
                    <input type="text" id="msgIn" placeholder="Escribir en #grial-chat..." onkeydown="if(event.key==='Enter') sendMsg()">
                    <div class="btn-send" onclick="sendMsg()">âž¤</div>
                </div>
            </div>
        </div>

        <div id="missionView" class="view-content mission-view">
            <h2 style="color:var(--gold);">TABLÃ“N DE MISIONES</h2>
            <input type="text" id="mIn" placeholder="Nueva misiÃ³n..." style="background:#000; width:100%; margin-bottom:10px;">
            <button onclick="addMission()" style="background:var(--gold); color:#000; width:100%; padding:15px; cursor:pointer;">FIJAR MISIÃ“N</button>
            <div id="mList" style="margin-top:20px;"></div>
        </div>

        <div id="statsView" class="view-content stats-view">
            <h2 style="color:var(--gold);">ESTADO DEL HÃ‰ROE</h2>
            <p>NIVEL: <span id="lvlSpan">1</span></p>
            <p>XP:</p>
            <div class="bar"><div id="xpBar" class="bar-fill" style="background:var(--xp); width:0%;"></div></div>
            <button onclick="localStorage.clear(); location.reload();" style="color:red; margin-top:20px;">RESET TOTAL</button>
        </div>
    </div>

<script>
    let state = JSON.parse(localStorage.getItem('citadel_discord_v1')) || { 
        name: "HÃ©roe_"+Math.floor(Math.random()*99), gold: 0, xp: 0, hp: 100, lvl: 1, missions: [], photo: null 
    };

    let peer, connections = {};

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

    function switchView(view) {
        document.querySelectorAll('.view-content, .channel-item').forEach(el => el.classList.remove('active'));
        if(view === 'chat') {
            document.getElementById('chatView').classList.add('active');
            document.querySelector('.channel-item:nth-child(1)').classList.add('active');
            document.getElementById('viewTitle').innerText = "# grial-chat";
        } else if(view === 'missions') {
            document.getElementById('missionView').classList.add('active');
            document.querySelector('.channel-item:nth-child(2)').classList.add('active');
            document.getElementById('viewTitle').innerText = "# gestas-24h";
        } else {
            document.getElementById('statsView').classList.add('active');
            document.querySelector('.channel-item:nth-child(3)').classList.add('active');
            document.getElementById('viewTitle').innerText = "# inventario";
        }
        if(window.innerWidth < 768) toggleSidebar();
    }

    // --- LÃ“GICA RED ---
    function initP2P() {
        peer = new Peer({ config: { 'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun.services.mozilla.com' }] } });
        peer.on('open', id => document.getElementById('myId').innerText = id);
        peer.on('connection', c => setupConn(c));
    }

    function joinRoom() {
        const id = document.getElementById('joinId').value.trim();
        if(id) setupConn(peer.connect(id));
    }

    function setupConn(c) {
        c.on('open', () => {
            connections[c.peer] = c;
            addMsg("SISTEMA", "Â¡Un aliado ha entrado al canal!");
        });
        c.on('data', data => {
            if(data.type === 'chat') {
                addMsg(data.user, data.msg);
                // Si eres el primero en la sala, actÃºas como puente
                Object.values(connections).forEach(other => { if(other.open && other.peer !== c.peer) other.send(data); });
            }
        });
    }

    function sendMsg() {
        const input = document.getElementById('msgIn');
        if(!input.value.trim()) return;
        const data = { type: 'chat', user: state.name, msg: input.value };
        Object.values(connections).forEach(c => { if(c.open) c.send(data); });
        addMsg("TÃš", input.value);
        input.value = "";
    }

    function addMsg(u, m) {
        const box = document.getElementById('chatBox');
        box.innerHTML += `<div class="message"><b>${u}</b><p>${m}</p></div>`;
        box.scrollTop = box.scrollHeight;
    }

    // --- JUEGO ---
    function addMission() {
        const t = document.getElementById('mIn').value;
        if(t) { state.missions.push({ id: Date.now(), text: t, created: Date.now(), done: false }); save(); document.getElementById('mIn').value = ""; }
    }

    function save() {
        state.name = document.getElementById('userName').value || state.name;
        localStorage.setItem('citadel_discord_v1', JSON.stringify(state));
        updateUI();
    }

    function updateUI() {
        document.getElementById('hpBar').style.width = state.hp + "%";
        document.getElementById('xpBar').style.width = state.xp + "%";
        document.getElementById('goldSpan').innerText = state.gold;
        document.getElementById('lvlSpan').innerText = state.lvl;
        document.getElementById('userName').value = state.name;
        if(state.photo) { document.getElementById('profileImg').src = state.photo; document.getElementById('profileImg').style.display = "block"; }
        
        const ml = document.getElementById('mList'); ml.innerHTML = "";
        state.missions.forEach(m => {
            const h = Math.max(0, Math.floor((86400000 - (Date.now() - m.created)) / 3600000));
            ml.innerHTML += `<div class="mission-card" style="opacity:${m.done?0.5:1}">
                <div>${m.text}</div>
                <div style="font-size:5px; color:#777; margin-top:5px;">${m.done?'âœ“ LOGRADA':h+'h restantes'}</div>
                ${!m.done?`<button onclick="state.xp+=20; state.gold+=10; state.missions.find(x=>x.id===${m.id}).done=true; save();" style="background:var(--gold); border:none; color:#000; padding:5px; margin-top:5px; cursor:pointer;">LOGRAR</button>`:''}
            </div>`;
        });
    }

    function copyId() {
        navigator.clipboard.writeText(document.getElementById('myId').innerText);
        alert("Â¡ID Copiado! PÃ¡saselo a tus aliados.");
    }

    document.getElementById('fileIn').onchange = e => {
        const r = new FileReader();
        r.onload = ev => { state.photo = ev.target.result; save(); };
        r.readAsDataURL(e.target.files[0]);
    };

    initP2P();
    updateUI();
</script>
</body>
</html>
